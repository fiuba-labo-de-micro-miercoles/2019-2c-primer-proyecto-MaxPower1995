;
; Comunicacion_serial.asm
;
; Created: 14/8/2020 12:21:50
; Author : mapor
;

.INCLUDE "M328PDEF.INC"

.MACRO LED
	SBIC PORTB,@0		;MIRO EL ESTADO DEL LED
	JMP APAGO
	SBI PORTB,@0
	JMP LOOP
APAGO:
	CBI PORTB,@0
	JMP LOOP
.ENDM

.CSEG
.ORG 0X0000
	JMP MAIN

.ORG INT_VECTORS_SIZE

MAIN:
	LDI R16,0X00
	OUT DDRD,R16			;PUERTO D COMO ENTRAD
	;LDI R16,0B11000000
	;OUT PORTD,R16			;ACTIVO LOS PINES D7,D6 CON RESISTENCIAS DE PULL-UP
	LDI R16,0XFF
	OUT DDRB,R16			;PUERTO B COMO SALIDA

	LDI R16,1<<RXEN0|1<<TXEN0
	STS	UCSR0B,R16
	LDI R16,1<<UCSZ01|1<<UCSZ00|0<<UMSEL00
	STS UCSR0C,R16	;8-BIT,SIN PARIDAD,1 BIT DE STOP,ASINCRONICO
	LDI R16,0X00
	STS UBRR0H,R16	;9600 BAUD RATE-->UBRR 0X68
	LDI R16,0X68
	STS UBRR0L,R16
	LDI R16,0X00
	CALL PUNTEROS
	;CALL DELAY

//ON:
	//SBIC PORTD,6
	//JMP ON
	
TR:
	LPM R18,Z+
	CPI R18,0
	BREQ LOOP
	;CALL DELAY
	CALL TRANSMITIR
	JMP TR		

LOOP:
	;CALL DELAY
	LDS R17,UCSR0A
	SBRS R17,RXC0		;VEO SI SE RECIBIO UN DATO
	JMP LOOP
	LDS R17,UDR0		;PASO EL DATO AL REG
	CPI R17,'1'
	BREQ ES_UNO
	CPI R17,'2'
	BREQ ES_DOS
	CPI R17,'3'
	BREQ ES_TRES
	CPI R17,'4'
	BREQ ES_CUATRO
	JMP LOOP
	
ES_UNO:
	LED 0
ES_DOS:
	LED 1
ES_TRES:
	LED 2
ES_CUATRO:
	LED 3

TRANSMITIR:
	LDS R17,UCSR0A
	SBRS R17,UDRE0
	JMP TRANSMITIR
	STS UDR0,R18		;TRANSMITO EL DATO 
	RET

DELAY:					;CONFIGURO EL CLOCK 16MHZ ARDUINO UNO

	LDI R20, 200
T3: LDI R19, 250
T2: LDI R18, 250			
T1: NOP							

	DEC R18			; 250 x 250ns = 62.5us
	BRNE t1

	DEC R19
	BRNE t2			 ; 250 x 62.5us = 15.625ms

	DEC R20
	BRNE t3			 ; 100 x 15.625ms = 1.5s 
								
	RET	

PUNTEROS:	;INICIALIZA LOS PUNTEROS EN ROM Y RAM
	LDI ZL,LOW(TABLA_ROM<<1)
	LDI ZH,HIGH(TABLA_ROM<<1)
	RET

TABLA_ROM: .db 'H','O','L','A',' ','L','A','B','O',' ','D','E',' ','M','I','C','O','S',' ','P','U','L','S','E',' ','1','2','3','O','4',' ','P','A','R','A',' ','C','O','N','T','R','O','L','A','R',' ','L','O','S',' ','L','E','D','S',0