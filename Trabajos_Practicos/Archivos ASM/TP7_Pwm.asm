;
; Modulacion_de_ancho_de_pulso.asm
;
; Created: 12/8/2020 17:50:48
; Author : mapor
;

.INCLUDE "M328PDEF.INC"

.CSEG 
.ORG 0X0000
	JMP MAIN

.ORG INT_VECTORS_SIZE

MAIN:
	LDI R16,0XFF		;PWM(0C0A) -->PD6
	OUT DDRD,R16		;SALIDA D 
	LDI R16,0X00
	OUT DDRC,R16		;ENTRADA C

	LDI R16,1<<WGM00 | 1<<WGM01 | 1<<COM0A1 
	OUT TCCR0A,R16				;ES EL OC0A 
	LDI R16,1<<CS00 | 0<<WGM02 ;ACTIVO EL CLOCK
	OUT TCCR0B,R16				;FAST PWM 
	LDI R16,0X00
	LDI R17,0X0F

LOOP:
	OUT OCR0A,R17					
	IN R16,PINC
	CPI R16,0			;SI NO ESTA PULSADO NO HACE NADA
	BREQ LOOP
	CPI R16,1			;SI EL CB0 ESTA ACTIVO, SUMA
	BREQ INCREMENTA
	CPI R16,2
	BREQ DECREMENTA		 ;SI EL CB1 ESTA ACTIVO, RESTA
	JMP LOOP


INCREMENTA:
	CALL DELAY
	CPI R17,0XFF
	BREQ LOOP
	INC R17
	OUT OCR0A,R17		
	JMP LOOP

DECREMENTA:
	CALL DELAY
	CPI R17,0X00
	BREQ LOOP
	DEC R17
	OUT OCR0A,R17
	JMP LOOP

DELAY:					;CONFIGURO EL CLOCK 16MHZ ARDUINO UNO

	LDI R20, 4
T3: LDI R19, 250
T2: LDI R18, 250			
T1: NOP							

	DEC R18			; 250 x 250ns = 62.5us
	BRNE t1

	DEC R19
	BRNE t2			 ; 250 x 62.5us = 15.625ms

	DEC R20
	BRNE t3			 ; 4 x 15.625ms = 60ms 
								
	RET						